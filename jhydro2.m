clear
clc
close all

%% Load Time Series
load QP_0000_1NOV06_0000_1JAN08
Total(find(isnan(Total(:,1))==1))=0;

Q.all=Total(:,1);
P.all=Total(:,2);

K0.start=1;
K0.end=69601;
K1.end=122689;



%% OUTLIER DETECTION AND REPLACEMENT
% Based on Menold 1999 "Online Outlier Detection and Removal" (MED)
N=5; 
y=Q.all;
d=zeros(1,length(y));
Q.fltr=zeros(1,length(y));
Q.fltr(1:N)=Q.all(1:N);
T=20; % selected after plotting d(:)
K=[];
for k=N:length(y)
    d(k)=abs(median(y((k-N+1):k))-y(k));
    if d(k)>T
        K=[K;k];
        Q.fltr(k)=median(y((k-N+1):k));
    else
        Q.fltr(k)=y(k);
    end
end
disp('...Filtering Complete')


%% Compute Estimated Trend and Seasonal Component \hat{r}(k)
M2=K0.end;
r1=Q.fltr(1:M2)';
Tr=288*365;
wr=2*pi/Tr;
Mf=2;

A21=89437;
A22=105984; % 1/11/2007 (to compute 1 year for periodicity)
M3=A22-A21+1;

A1=[ones(M2,1) cos((1:Mf)'*wr*(1:M2))' sin((1:Mf)'*wr*(1:M2))'];
A2=[ones(M3,1) cos((1:Mf)'*wr*(A21:A22))' sin((1:Mf)'*wr*(A21:A22))'];
r2=Q.fltr(A21:A22)';
rcoef=[A1;A2]\[r1;r2];
M2=K1.end;
A2=[ones(M2,1) cos((1:Mf)'*wr*(1:M2))' sin((1:Mf)'*wr*(1:M2))'];
rhat=A2*rcoef;


%% RMSE Root Mean Square Error NOV 2011
rms1 = sqrt(mean((Q.fltr(1:69601)-rhat(1:69601)').^2));
rms2 = sqrt(mean((Q.fltr(89437:end)-rhat(89437:end)').^2));


%% RMSE for Week
QQ=[];
for temp=1:7:232
    period=(temp*288):((temp+7)*288);
    QQ=[QQ; Q.fltr(period)];
end
plot(QQ')
Qmean=mean(QQ);
plot(Qmean)

rms=0;
i=1;
for temp=1:7:232
    period=(temp*288):((temp+7)*288);
    rms(i) = sqrt(    mean(    (Q.fltr(period)-Qmean).^2   )    );
    i=i+1;
end

%% Find an average week
QQ=[];
for temp=1:7:234
    period=(temp*288):((temp+7)*288);
    QQ=[QQ; Q.fltr(period)./rhat(period)'];
end
plot(QQ')


%% EXAMPLE 1: ONE WEEK DECOMPOSITION
temp=127; %30N+31D +31J+28F+7 for 8st March 2007
FourierTerms=100;
period=(temp*288):((temp+7)*288);
s_est_tmp=Q.fltr(period)./rhat(period)';
Tr=288*7;
wr=2*pi/Tr;
A1=[ones(length(period),1) cos((1:FourierTerms)'*wr*(period))' sin((1:FourierTerms)'*wr*(period))'];
rcoef=A1\s_est_tmp';
s_est=A1*rcoef;
n_est=Q.fltr(period)./(rhat(period).*s_est)'-1;
period2=period/288-120;

figure(1)
subplot(2,2,1)
plot(period2,Q.fltr(period))
hold on; grid on; axis tight
title '(a) DMA Inflow signal'
xlabel 'Time (day)'
ylabel 'Flow (m^3/h)'
dateaxis('x', 8, '03/08/2007')
subplot(2,2,2)
plot(period2,rhat(period))
grid on; axis tight
title '(b) Seasonal signal'
xlabel 'Time (day)'
ylabel 'Flow (m^3/h)'
dateaxis('x', 8, '03/08/2007')
subplot(2,2,3) 
plot(period2,s_est)
grid on; axis tight
title '(c) Periodic signal'
xlabel 'Time (day)'
ylabel 'Flow (m^3/h)'
dateaxis('x', 8, '03/08/2007')
subplot(2,2,4)
plot(period2,n_est)
grid on; axis tight
title '(d) Uncertainty'
xlabel 'Time (day)'
ylabel 'Flow (m^3/h)'
dateaxis('x', 8, '03/08/2007')

[a b]=lillietest(n_est) %normality test

%% Initializations
qr=zeros(K1.end,1);
p=zeros(K1.end,1);
q0=zeros(floor(K1.end/288),1);


%% Efficiency of estimator
    M2=69601;
    qr=zeros(M2,1);
    er=zeros(M2,1);
    qrhat=zeros(M2,1);
    Ts=288*7;
    b.w=2*pi/Ts; % Fundamental Frequency
    sf = @(k,b,j) [1 cos((1:b.n(j)).*b.w*k) sin((1:b.n(j)).*b.w*k)]';
    s=zeros(1,M2);

    % RUN SIMULATIONS
    ks=4033;

 gamma=[0.01];
 rmsqr=0;
 b.n=[100];
      
for j=1:length(b.n)
        theta=zeros(2*b.n(j)+1,M2);
        for i=1:length(gamma)
            GAMMA=gamma(i)*ones(2*b.n(j)+1,1); 
            for k=1:24032
                qr(k)=Q.fltr(k)/rhat(k);
                if k>143*288 && k<=299*288,  dst=12; else dst=0; end  
                if k<ks-1
                elseif k==ks-1
                    Tr=288*7;
                    wr=2*pi/Tr;
                    A=[ones(k,1) cos((1:b.n(j))'*wr*(1:k))' sin((1:b.n(j))'*wr*(1:k))'];
                    theta(:,k+1)=A\qr(1:k);
                elseif k>=ks && k<=20000
                    z2=sf(k+dst,b,j);
                    s(k)=theta(:,k)'*z2;
                    qrhat(k)=s(k);
                    er(k)=qr(k)-qrhat(k);
                    theta(:,k+1)=theta(:,k)+ GAMMA.*z2/(0.01+z2'*z2)*er(k);
                elseif k>20000
                    z2=sf(k+dst,b,j);
                    s(k)=theta(:,k)'*z2;
                    qrhat(k)=s(k);
                    er(k)=qr(k)-qrhat(k);
                    theta(:,k+1)=theta(:,k);                 
                end    
            end
            rmsqr(i,j) = sqrt(mean((qr(20000:24032)-qrhat(20000:24032)).^2))
        end
end
  
%% COMPUTING THE BEST THRESHOLD FOR DETECTION

    M2=69601;
    qr=zeros(M2,1);
    er=zeros(M2,1);
    qrhat=zeros(M2,1);
    Ts=288*7;
    b.w=2*pi/Ts; % Fundamental Frequency
    sf = @(k,b,j) [1 cos((1:b.n(j)).*b.w*k) sin((1:b.n(j)).*b.w*k)]';
    s=zeros(1,M2);

    ks=4033;

gamma=[0.01 0.1];
rmsqr=0;
b.n=[100];


phibar=[1];
Ser=zeros(M2,length(phibar)*length(gamma))';

jj=1;
for i1=1:length(phibar)
    i1
    for j=1:length(b.n)
            theta=zeros(2*b.n(j)+1,M2);
            for i=1:length(gamma)
                GAMMA=gamma(i)*ones(2*b.n(j)+1,1); 
                for k=1:69601
                    qr(k)=Q.fltr(k)/rhat(k);
                    if k>143*288 && k<=299*288,  dst=12; else dst=0; end  
                    if k<ks-1
                    elseif k==ks-1
                        Tr=288*7;
                        wr=2*pi/Tr;
                        A=[ones(k,1) cos((1:b.n(j))'*wr*(1:k))' sin((1:b.n(j))'*wr*(1:k))'];
                        theta(:,k+1)=A\qr(1:k);
                    elseif k>=ks 
                        z2=sf(k+dst,b,j);
                        s(k)=theta(:,k)'*z2;
                        qrhat(k)=s(k);
                        er(k)=qr(k)-qrhat(k);
                        theta(:,k+1)=theta(:,k)+ GAMMA.*z2/(0.01+z2'*z2)*er(k);   
                        Ser(jj, k+1)=max([0, Ser(jj,k)+theta(1,k) - 1 - phibar(i1)/rhat(k)]);
                    end    
                end
                jj=jj+1;
            end
    end
end

plot(Ser')

%% Minimum night flow

%gather the first 144 days (from 1/11/06 to 25/3/2007)
mat = vec2mat(Q.fltr(1:144*288),288);
MinNight=mean(std(mat(:,(12*2):(12*5))'));

%% Compute the maximum value of dw based on the last 100 measurements
Mw=7;
qnorm0=Q.fltr(144*288:241*288)./rhat(144*288:241*288)';
mat0 = vec2mat(qnorm0,288);
w0=[mean(mat0(:,(2*12):(4*12)),2)];    
for l=(Mw+1):length(w0)
        d(l)=w0(l)-min(w0((l-Mw):(l-1)));
end
max(d)



%% SIMULATIONS FOR NIGHT FLOW LEAKAGE DETECTION
M2=length(89440:122689);
fbar=[2.06339017868616;0.570997854428706;1.68746828261794;1.73836148040234;1.31620500588480;1.54371389638708;0.904694141795967;0.563141401096418;2.29037618442411;1.79795573554704;1.16676044273105;1.53467455172723;0.919569522814214;1.11201960915156;2.39567965925659;2.59447191403739;1.69386589883459;1.22012357367629;2.39468694393090;2.33430849839885;0.663684151597915;2.97456348079292;0.599200254021462;2.44478115590714;2.93313164349032;1.53781908264031;1.27694211160338;2.01001242849506;0.836880059220147;0.955612291314478;1.63684043993475;1.31255155384370;1.69203709969741;0.614187770735071;0.563136915655809;0.721110572152441;2.33983224601450;2.50740890627012;0.997753419407512;2.79415529371589;2.74401476205299;1.95918451739701;2.20230081576058;2.58700542237036;2.38710010242125;1.94546025194142;1.49988949991616;0.606555503449890;0.623816370856647;1.25825829461439;2.33853911970508;1.26295120868172;1.38480048133570;1.89487263272383;0.979321188273738;1.97086328302830;0.606984925379873;2.50189398673828;1.41385338647025;1.11302112584160;1.90114076670825;2.06062019404994;1.25593982812917;1.68141939537479;1.96973432142757;2.67722562353716;0.925086641348492;1.71018127116226;1.82678270999154;2.58841716615137;2.77391112766718;0.503682192170047;1.03577437931156;1.14998756016590;2.11364556773082;2.89108248112040;2.52447036293388;2.02996640157830;1.32758275200787;1.52788112031897;1.96247107586539;1.38391925367679;1.49581207271902;0.506136854700841;2.18824137064480;2.81171197153448;2.98189433625604;1.08497671689842;2.68484422891456;2.25359239203221;0.725526909643198;0.616214351414668;2.67972120835891;2.88456415621833;2.90550878613409;0.815865140002195;2.34270124620999;2.93895091490830;1.41693943668837;1.77243695753233;1.28860817101660;0.818589816931928;2.54431049794010;2.36382853461812;1.99111277499994;1.93890670401980;1.15213710262093;0.661011896707883;1.59210239727375;1.88126668277270;2.12214689392350;1.58092889913145;1.54196464073732;0.629341379730426;0.899529405340379;2.45820919233273;0.869617779518109;2.77287645438456;1.97858571829315;2.71636045021784;0.634112050619192;1.66575217982158;0.780217237014033;2.75182002824191;2.88255263624824;2.53176139492088;1.32972150463895;1.17808197151226;0.628096152959403;2.72320530359180;2.96333137782089;1.41089992278271;2.11582691715777;0.572193466821045;1.07580695370325;2.30179074541145;2.81098663910389;1.91869527661367;2.59692477997351;2.81904957501941;1.12898739660155;0.583327241615686;2.30523381224864;0.618786273850011;1.88583557374042;0.642152331208615;2.74689099670655;1.80756004010182;2.30748935921933;0.847887276233919;1.15435116385754;1.13535115971526;2.47996000479709;2.73570370108173;1.68281705240710;1.99803002366716;1.58932836351285;1.68785394645631;0.895609999812404;1.23631699944420;1.98749477368858;2.52184852446727;2.83063481989661;1.97222935631455;2.69573828048179;1.22447611624258;1.58507439417469;1.69189343028272;1.76881640458465;1.80478284097987;2.99474600563867;2.67527653942708;0.824964535665054;1.06606539208172;1.68181093090736;0.806105193852790;1.00837205513475;1.68165771746892;2.37941586805862;2.23658791165834;0.751547651104115;1.45373489591589;1.59005791062339;1.11876261191314;2.00882282439434;2.75761245490960;1.80903999689098;2.77237621852066;2.60745637823131;1.15136298984106;2.84421118783602;1.11634085427587;1.81711095651101;0.700409264215839;1.07561925447949;1.66129102700973;2.69927685473174;2.92482290802892;1.49767755629641;2.75358837604645;0.637410928875228;1.27795493549783;2.64074500212089;2.64531328143489;1.96064992021014;1.09645216733516;1.90352549730356;2.91011622499525;1.99098970877551;2.86260245348652;1.91960000754915;0.953675012619978;2.18743172328865;1.69586414831963;0.794094118904000;2.77783925093944;2.47130162400944;1.85612992355907;2.35965035590696;2.80428728644200;2.16421050203484;1.73402196214383;0.874352766871851;1.10009471795064;2.93556058210973;2.75839500096958;2.28875928320824;0.966538799751548;1.13572331401478;1.76586952395325;2.16071913139787;2.15395973047752;2.82525244004202;2.44749487048879;1.20855293259909;0.605244355408650;2.65892091446558;2.85752279371052;0.686939453536680;1.20820216037715;0.641614013919849;1.01985073754103;1.68822149363211;1.81493903405574;1.03171959247383;0.950040788709102;2.34515921651740;1.86160120808320;0.596108008171829;0.832845852525215;0.698175102758264;2.68767312223415;2.61550380218394;1.74753348542660;2.66108642719293;1.75618870674612;1.89441221980801;1.75716083796710;2.63368796635922;1.04075114568798;1.30438506732750;2.17134259338622;1.55514785200476;1.84877544510329;2.16541965507761;1.77854469076194;2.32149516588591;2.63598676991820;2.76344148482117;0.507871572467871;1.65792518689583;1.84137515431531;1.08380615861657;1.20358709193106;0.923378398598088;0.890391234945538;1.55513568517153;1.09490147844237;2.67961944156290;1.22980417991128;0.805608764821971;2.55936982008206;0.877629286522597;1.17509089676301;1.58399403329258;2.90504066296265;2.49119605516516;2.01675925069135;1.98199222718453;2.09737452755762;2.52227851761405;2.79445262348814;2.74531415932310;0.937082707835594;0.902631550900191;0.583820968493415;1.34606465280104;2.35601613925572;0.588484122296137;1.37092077813757;2.43639260973926;1.71860919748750;0.736202645344383;0.754002467868055;2.27220348306046;0.742145149411182;2.19240862736692;0.922487671974434;2.49275555789525;1.02083451222415;2.12816699622305;1.49371510420005;1.69718840019281;1.85528134233895;2.14951477493246;0.986573738017678;1.27667035032578;1.02019045719829;0.616553810347926;2.49928972670666;2.55732795292941;2.35744409356745;1.72585567391871;1.92557159579013;1.42100733776064;2.58837016100663;2.74931772428516;2.15344725256476;2.44735953894612;0.507037899272767;2.67504902242293;0.671272907393635;1.93321724887230;1.98001313527708;2.55114754076918;2.03378607429572;1.84458067146555;1.83976516184935;2.93318640702061;0.827865772635022;1.92423924952353;1.57337634221043;0.678650942102357;1.22822466113398;2.79631358731515;0.755214285126258;2.05360780486650;1.65608146811826;2.91537361085748;2.97581298918852;2.57782540667847;1.74574947484855;2.62190043553591;2.69922942939855;1.76201750636571;1.82461383183772;0.910959525483048;2.12866844352827;1.00316908824176;2.85950040614267;2.98185016207147;2.76682022660969;1.77568020496620;1.35513253495545;2.58932156265733;0.707884515833942;0.734853501169386;2.05435461213312;0.845159565958945;2.96277683404346;0.699280008954554;1.93651267185270;2.11836812671524;1.71148505266984;2.63550602810369;1.46627549151425;0.659373572551535;0.966769700788144;1.45235026235426;2.37151965288177;1.02688124520084;1.61159450677549;0.995026931889459;1.22462012648989;2.68924555343704;1.97720641661665;1.03320232261480;1.71043047996722;2.26897074285426;1.18247521040371;2.39664650572326;1.85049903966622;0.805267705258340;0.827640303450470;1.73907620943868;0.561033461117276;1.05729758186727;1.39097633741475;0.908739829994210;2.39674991901659;2.57480808550287;0.764381967515048;1.36353064702913;0.521784576196402;2.05756462873384;1.03703767074772;0.825765530300640;2.66188754183218;0.972250010997393;0.765472851592419;1.73233777013473;2.32606661529612;2.67528265026865;1.41453624178745;1.93785986217420;1.12536710590380;2.69948767188583;0.608941431023724;1.99606968310674;1.10941358527368;2.64449905996279;2.44188907399827;1.45779491214009;1.90340179515067;0.719697559054142;1.97465844017631;1.45085753841766;0.639126922687414;1.52646330400282;1.77103636126502;0.776842385878337;0.898609522263205;2.59734602429104;2.46724505711440;1.48094404239256;2.55099905277831;2.53390007494829;2.32461448631486;1.85360541606773;0.566337464580563;1.56376549990076;2.46219668484284;1.76599362791293;2.03844236842305;1.65965081789082;2.02464724546852;2.21976356384857;1.11939187631158;1.83221818947406;1.60493033884677;2.01169230035739;2.94508932972564;1.01076159764972;2.26366791481266;1.53118611116455;2.35922324957904;2.17366489543601;0.948536053349846;1.70794909865064;2.64535835557304;1.67225565577123;1.54369529313569;2.16913962768493;2.02568290707038;2.98682707472753;1.42221139657562;2.64005752565922;2.49107823599988;0.964253552289133;1.39602530825428;0.750208945941209;2.84638277416610;0.678156083415484;1.40876120254706;2.53025139510470;0.697938172437049;1.21315816697329;2.27848908566419;2.01247347727054;2.96846104548752;2.32373437702674;2.29327738875681;2.17097870531652;1.99056441697817;1.05710776676593;0.954915288380737;0.616664759505808;2.04997036887330;1.72770160690145;2.01953614211641;2.73437620151167;2.67911092184384;2.81224404772720;1.50351757696508;0.745214992500555;2.27574462854393;2.83319304438133;0.943574530001884;1.96846734716783;2.88264728796885;2.09200810240191;2.69787307335295;0.558827014754002;0.708732392744198;2.35043633656115;2.55185396423922;1.19560141733090;0.913340328256764;0.759822398970250;2.94100234778521;0.596981035170950;2.70673718384058;2.89391627264781;1.37921702467703;1.17184915426645;2.89405788031034;2.70885229159780;1.55450160003909;2.11040977494869;0.662673726386250;1.55060549590896;1.60853692546583;0.808330097488536;1.49081226618661;1.93749672264692;1.91277671089453;1.25839146999184;1.09960238040822;1.57736547035304;1.83993048434169;1.95967707978963;2.06542300978600;2.28818247842394;1.74669018326953;1.19217712076184;1.40828208371744;1.26569314502163;1.78004558106289;0.999367048905104;0.716128566655868;2.46750916309977;1.73562532241439;1.89749350543724;1.48421932571890;2.96281053255786;2.26034942034742;1.17933170047631;0.510546657160746;2.14428421218064;1.70007860132792;2.72353894005311;0.720771075240338;2.87754991586824;0.723566927653066;1.91311660581789;1.26760361052640;0.775505866386867;0.517077091420545;0.716631657031534;2.36762603080050;0.624264233415762;0.964747075723301;1.33818178723333;0.876239474429056;0.596169065159369;1.25804249667001;0.773692025419302;2.81507414127701;2.47079272109246;0.726056788743525;2.67601410690363;1.81519036218673;1.46256659543253;1.73640921896914;1.10339131421834;1.94441032779996;2.62759967895033;0.780599189321226;2.52123824953015;2.32217528646831;0.892820377336325;2.13858323768447;0.643257601408104;1.27123709313809;1.38550798657470;0.575684888272676;1.48805414390701;0.869287377444550;0.901253204606978;2.76553580752720;2.36964893763232;1.78234504444296;2.87588756315110;2.30843203630263;0.910778104097081;0.963292108293266;1.00696980083917;0.603206335455998;2.83436400277310;0.735031600212586;2.90595976250418;0.502548104758948;2.01549799726560;2.91197492766057;2.22400335602465;2.85147068595962;1.74200696940197;2.00933300647223;2.37653402920967;1.72530300682838;0.572935208502133;0.662927637424827;2.72024487769030;1.39954334160207;1.42988086046915;0.811930162018568;2.39562681888843;0.901988709408778;1.36463723753026;1.14346579684248;1.70455216572305;2.10921824012356;1.82012896965121;2.82816840410808;1.16065401136030;2.03377023122072;2.31512978331536;1.01846478493453;1.49332942960639;2.55728313168530;2.02978800846162;1.76220248795482;1.85916479053270;1.73053893025225;2.60106072854653;1.56906889772669;1.97828921600261;2.86484560134939;1.30619953011933;0.814392497939802;2.03372161456478;2.08516848708723;1.47858651524972;0.964247712791019;0.939324102851505;2.53278832572580;2.44408581580491;2.01534301470192;1.27471571677852;2.03733169646497;1.62972044915420;2.00955543526640;2.08046653807670;2.37120247704874;0.612096266177021;1.63377197611578;2.89661932313160;1.51080318977715;1.72164057378333;1.54655336325757;1.60122820730727;2.81196925815816;1.26938276864782;1.89439809477194;0.695490361618343;2.87508948342814;0.805148276842969;1.44085448395881;2.80241495055999;2.84714038922842;2.28303079687416;1.71706931724626;1.38732039659497;2.80906701642282;1.99098810738784;1.22049172463023;1.98761040045970;1.90226677765333;1.75065494864478;1.65395327767305;1.78240321251429;1.67402822263532;1.90788461953440;2.15463865233018;1.65804482534041;1.42867182761765;0.924346668047280;2.80390900787030;0.996128166172341;1.18729560786298;1.09845783929938;2.46192250217393;1.90703028124899;2.88544646627170;1.42908595000966;0.636247875750461;2.06345048118317;1.66405263648297;2.36440239318217;2.75301488427693;2.59950484858495;1.33081600376166;1.24519190730922;1.06680469024426;0.544905643282943;2.74269666096559;2.31936423794591;1.19263209457454;2.22347598528464;0.759173531522454;2.87194860583091;1.23615560775614;1.25346275931427;1.75425982132989;2.66753110614011;2.94241042314495;1.04400069965277;2.99169875666319;2.19163216126867;1.21985813070326;2.81741173616630;0.575700339513141;0.734362405469246;0.912686685603088;1.80992080456695;1.89286818994345;2.97876716384852;1.47308534388624;1.30991977091696;0.883779187888653;0.886932331108925;1.39521752160696;2.27798512290060;1.06020587719352;0.842955561731733;2.36551037648004;2.81391103803990;2.98743694291717;1.93513930916613;2.10259333298721;1.89601753339455;2.74859210558694;0.551204983247235;1.39573383727205;0.863327441181092;1.58104697659448;2.09990693543522;0.504424458592331;1.76973600345326;1.46242303335864;1.61690426857099;0.814573186777304;1.12586851125158;1.74620372707804;1.17238988601492;1.69904977793717;1.03253681947760;2.08843230466565;2.10380119619635;2.99376208347584;1.17968274601502;0.637575433736611;1.18628488104006;2.84559800643484;1.88100345302902;1.86965489730153;2.38874138643203;1.99608484437304;2.27364382353192;1.04945808387477;1.55300404069532;1.21073321551089;2.83066523703654;2.43433605587999;2.94187408533608;0.716355104439475;1.98990723671287;2.13598177274473;1.99671398936094;1.04324857666217;1.75927681863581;2.96450415655217;0.513965220439701;1.69700669509128;1.99576871517781;1.71338923905023;2.78138082519623;1.07007731172388;1.30837854498754;0.630109990503213;1.91318293814492;2.62494598398081;2.36952838145297;1.70602246848725;1.68116657984060;1.19150470970698;1.91933843470764;2.49726013158944;1.78219175238466;2.98874060998270;2.19609277860031;1.57327318375452;1.89096820453852;1.10637688896612;1.31979207554932;2.59317253690786;2.42705815353331;2.84348652456421;2.73991578573056;2.79013180700708;2.63906570481914;2.94657589992427;1.68108119132571;2.84694647964932;2.98746000954392;0.918524204341839;2.79406558279767;1.45814446517380;2.78815447836264;0.586924169301849;2.38368359341269;0.937593109563735;0.969424371082392;0.855270000704268;2.47965150616352;0.762892054163249;2.47367790107914;1.04145397382190;1.44067535332616;0.791103871777969;0.512805367899277;2.79598810175146;1.46036174069386;1.12969551703858;1.68992228809507;1.32220412162127;1.26689340956419;0.964182468204317;1.71398358024493;1.74399396407645;1.23717930020851;2.52304303587712;2.31170537907531;0.926905049457093;1.27248167844071;2.22036619031809;1.38315480413977;0.840495498886507;0.902998038208515;2.25399513673308;2.90776075084687;2.62228821467590;1.38924070390718;2.01006592725440;2.65802067718791;2.55129150532262;2.64181501659317;1.69805573964426;2.23312591257556;0.960486725913173;0.900095306502776;2.98732495959065;0.665298801063670;2.98151510265010;1.04417020745248;2.71390956283538;1.34304132626467;1.29113450290242;1.27615736126127;2.28278214617162;2.15919954907962;2.29492778361366;0.761600859724451;2.25119755206048;0.701466074456010;2.72798880781299;2.23470040436505;1.59118724833873;2.14247777366781;2.87023561677107;2.42763466145836;2.70838246453987;1.35743566504529;1.28166199529329;1.76922204553310;1.78130762569084;1.95461705847681;1.25696549785131;1.10179923890256;2.29108889543768;2.42475813905912;2.47810033496908;2.32502933508745;0.621147907014549;1.21579463951766;2.12115965587301;1.87993629588684;2.26192249496954;2.87305438449285;1.50918658771251;2.68688955896174;0.668340023086901;2.50966814390013;1.34352365185881;2.43858153941737;0.654964080394976;1.93842029951941;1.87691427765485;2.49860203147364;1.44608847013230;1.83562627726873;2.87520709488397;0.802764177669268;1.40315078797171;0.860386547279106;1.97181310738050;1.86477848644458;1.34001884744321;1.23640765823267;1.92542546537972;2.50598052733179;1.49556372665097;2.22167401772672;2.77179418931574;0.784383510306737;0.785920125460244;2.07068710640837;0.806297423240038;2.24054509963959;0.754726673600668;1.72868207946130;1.52575518291782;2.75202178677430;1.79081956366761;2.18007679274951;1.02180222752635;1.82855790444679;1.79501251449378;1.88293689909156;0.848669710438207;2.70677135875053;0.808329897482274;0.914647203125934;1.54129195573323;1.74619982046889;2.60416218763029;2.86609390145664;2.40126079925208;1.91031477993898;1.91536313851135;1.71774894117764;1.44389033749512;0.703496969776358;1.98865086499833;1.93343242880892;1.00051323835190;2.05606705353924;1.33329326974489;1.34085509876736;1.48381710719618;2.06869098255856;1.60365813828783;0.994465911705074;1.13257585772817;2.47644546642542;0.725562477116661;0.640890091084956;1.38044821826330;0.717734021881440;1.77761158316501;2.55758619252070;1.05859740285190;1.99564514331866;0.713435227036447;0.600852681308299;2.85982950720300;1.63882474320436;2.88471301271248;2.52575131191081;1.66950140102615;2.57382847973272;1.05026419062611;2.85125715099229;1.24025923965383;2.80041007331942;1.26944776242853;2.38530332190560;1.36564841470274;1.04381836750636;0.506235845466756;2.99921405686824;1.53990973476609;2.12768966826881;2.33070913169874;2.35259690112449;1.18634369084274;0.869240704043362;1.12784605572488;1.87186499775621;2.87791374289357;];
k0=[103726.591765696;95715.2339677754;100467.493230216;101919.839115834;107672.926797735;109010.561940787;115967.949911961;97836.8855201880;113697.933850795;95362.7044796634;94363.3186669653;110082.188409634;101136.924453097;109820.258032859;104587.118899747;107927.132139201;102004.646251029;100143.526789746;116003.954362502;108799.435369656;103959.586546660;117670.588663469;100729.254843137;115950.110604059;103061.563015941;116735.938691525;108235.204196918;102308.105819497;100938.076523475;102036.330307190;109463.870204248;97078.2972482126;113106.454840496;100546.546318372;100927.260139971;103421.058940941;101461.968474025;99366.6249468958;99428.3841377131;102976.095414030;95392.7431269888;113634.059398915;99208.7172222631;98328.4348429363;100023.831536828;95469.0199565494;112416.377251995;99052.0673470872;109128.831507232;95581.5124647545;113364.874097165;93948.7083797879;97071.9859510480;107588.607210064;98508.8863593318;110458.014658098;99781.8915063330;103868.780987834;108790.792802332;99257.8102696384;107084.448627364;97725.8348283562;105031.619051410;100078.814590609;100321.429908016;108610.834967920;112205.889888472;102910.611193154;116973.916460416;112403.259674460;101980.688115618;113202.992218004;98781.7153393112;113058.600198580;112510.777250713;101614.886864357;107031.923442312;105464.491485583;105759.818008192;96030.4957847805;100909.216444656;97260.2233842787;106280.056496363;108899.339130404;104375.893517644;114415.621988590;99487.7797108331;98451.8121524790;96507.2059984170;114818.696079078;95079.2166327495;115159.553397009;94917.9046864750;118216.304629710;106053.320442478;104615.458318120;104463.936098571;100818.031132957;101594.342207847;118324.338684021;118553.161141129;95237.1657010245;104049.475005386;107198.652844326;101112.347992574;100076.428507270;102329.873252053;112691.329344905;98015.1130619927;93475.2771758672;105804.675423384;100523.825051064;103944.126932636;115856.300892764;93622.0425172250;114960.649456143;102500.724965275;106723.756965422;114156.326504167;117256.664714933;97178.7391899531;117708.281258557;114236.779308664;108740.068353688;101784.453977314;112427.972714767;115192.916724471;104987.460754530;105452.632418891;94375.2248344308;115115.699600303;105221.132745077;106087.273763979;112868.447770232;115128.465062771;96078.0963839504;106843.970981054;118546.944845527;111317.565988444;111481.093540114;110592.301455840;108676.737865211;104552.503168559;97131.0107956016;102393.198171714;98793.1827628920;98668.1506057901;111056.861630037;98012.0326364352;105364.636675231;114481.594853260;115004.486341115;116346.795137767;112552.724610692;95378.6033838251;116576.447144994;111497.272155790;110503.955212756;107028.529015516;118401.239855694;96608.0416150436;115942.176476156;94106.7847717745;104587.814656791;93794.8077103705;110801.548471592;109866.372620531;107221.057554414;111130.508919334;99238.6598990463;97333.3026291675;97395.5533647228;107022.532811116;95464.1600319778;116961.235144091;97197.3282319965;105911.859302591;115322.779043747;101325.941140690;94373.0521568273;99732.2341107085;103042.398531132;116361.421157874;114961.790093963;111682.748415548;96536.7524244263;105057.965613390;103400.617404664;108654.546063401;117119.698264595;107663.485309912;108761.391961924;110627.359014794;99826.7930925680;106979.768980002;97051.6447482423;109174.122404485;106886.638746347;95189.2009845130;94199.6144580246;98256.6485147827;98764.4868913894;104411.066128024;106180.199937504;93931.1336192726;110941.404888863;97115.8729090294;118325.733980971;117625.456803263;103891.956707072;99716.9661122629;105572.345788811;117171.446247979;98281.7735795070;95118.2965363523;98587.4236659999;100047.422793229;94504.4807921543;116521.604092619;102168.039070185;109326.336577201;117727.730676922;93856.6514610633;103880.681373588;115890.419734026;115492.415696595;113882.697655140;105103.082384089;99364.9613287888;109804.006436624;98164.9383156739;98845.0225761048;96938.5912769883;118579.905697816;114047.763127403;109973.489211568;108314.473771486;108410.494470068;104327.511920314;106760.356432307;101784.874495219;99552.2876948209;114905.241263883;116491.485353474;103012.729505981;103082.472077782;106683.613725544;98951.7857597960;117643.057348795;98218.3683392946;108691.327442717;115709.308344162;103997.755178853;101716.659049480;100612.062982263;102708.793133667;113153.763507334;100982.291866289;116446.473079119;99899.4451744446;107966.426321436;95708.5168393278;106501.937186872;117630.316195314;98435.1628602604;115023.666705872;107548.347729415;105301.730249503;106103.532051396;114921.446732196;95935.3150541470;112083.676475687;97726.7774104294;97947.0196764182;101792.298028963;98876.6592860105;93899.8477512207;110318.926733217;105841.688788028;103957.977830105;102476.017925434;106223.582256751;95859.9202149134;107524.979335398;108099.147511879;106400.442379309;104114.957616088;105168.186393703;97632.2279418686;105428.504530365;103529.840689963;118654.601816865;98923.5581487720;101632.364453750;100566.647992519;100221.398093316;110273.247135110;99974.9245691018;108547.748053736;111039.830853984;104309.138580136;94310.3373739947;106432.152178040;98347.6431918508;109266.304434975;101283.575708029;99221.6192767780;95707.2970983694;95153.6253806481;100334.356282789;109200.790830356;100212.241821106;115198.827096381;116198.138542893;105331.946340996;108521.100052756;109565.879640300;99768.9733788286;105954.260884431;109855.409624408;93684.2842253128;106686.407770871;113789.136616253;100935.920939919;95548.1058550833;111071.357017665;112732.689966729;95148.2978907885;117547.970224833;108927.286849143;105574.157276254;94164.6137726116;112703.451893695;116907.562309203;97512.8948574331;117001.141192130;100654.487828087;99810.5205262284;99712.1432471814;98153.4479771646;114091.368586095;106888.569206693;110311.773953525;97141.6772519247;114823.451370899;104057.398068740;94619.6022741311;94465.8057183834;116280.663017542;97739.1050077112;115033.542290478;99133.4203304509;106124.779508720;113673.660543763;115904.527904256;111890.159437060;116414.423016924;99175.4547646120;103502.653901750;97018.7624041733;105225.203067390;103294.743562722;113122.584301769;95933.9878907148;98571.1924777983;113823.446254530;93536.8435979391;116089.001393149;107825.062309589;97230.4422194288;111779.031396134;111561.400866146;95223.7399234723;106789.637944174;98179.4294680324;98487.8634648101;110931.414742793;101434.957252337;115246.532412474;107925.964307169;98484.4001836406;109624.549346896;103532.241383401;93850.8963761259;102422.575328331;102939.736127137;111790.332950507;94553.6353434223;116510.729603996;116871.722397922;107482.992205944;104249.378657863;116567.700570204;118192.758477742;96251.9687286567;111159.081500952;97483.0796032561;97538.7388346809;109541.971426394;99005.4883655930;106937.234213136;102292.765252417;106201.198530227;105720.159884525;117022.792970340;95246.5447485851;115661.808201171;107449.236949678;97907.2169116301;115297.964008406;110618.128616482;113748.082406931;112958.658166947;104255.769051823;94602.4924196656;109382.011433491;95133.7511929937;107961.882630960;97561.3704776422;111449.129532720;102941.129115610;98932.7852966056;117171.181972070;95695.5158313009;96221.8614340777;115494.638698623;112622.978694624;95851.0400783955;108543.420734380;111301.289706599;105549.664491666;116293.764956630;95779.1295633323;101022.732584361;108533.243926178;117867.147633197;112488.697984220;110990.087838416;99504.4810356671;104226.785581947;108206.705691538;104792.056578573;102258.878711411;114532.761359065;114497.044080682;116842.685654216;106010.905258920;111095.910157393;99391.9257549181;94630.6564610137;99532.5848279702;103404.462757458;100352.188543533;96399.9844605054;105721.161401546;113725.293435330;117857.867825012;103389.231494823;96777.1408364212;112897.466179712;96489.9012936054;109153.719869140;108617.510235017;99342.0067804088;101392.669996740;116335.308389547;106745.369665811;113816.022014997;108168.719424393;102021.514377748;94869.1399838602;97004.9726595809;111651.328039569;112445.370858744;110252.600753728;108104.567200985;112120.474627827;112463.103965155;100213.274938292;116634.487861068;113263.065014569;117488.563328487;113925.527386234;106340.479504010;111626.355584313;112465.794265979;109448.861770010;97691.3633091079;100654.166564554;103389.364068835;112057.118575276;108086.827350133;94498.4910149398;94574.0428373555;96475.2113292983;115660.088908481;99140.8722597552;115938.270759013;113220.541121245;112008.063043044;95464.5414663018;103907.076610164;113337.549765316;106967.928474618;116109.663667736;93760.8802528732;103194.239319306;96352.9539133621;111751.279780778;115491.623012662;117735.626940207;100977.803603242;93963.9526679041;93988.1834572917;96536.4765584063;99395.3762736166;94587.2941686420;117482.272859644;111905.981257294;105059.066531117;107187.888314800;111661.283929097;94193.9704212305;93818.9949607200;112153.914716226;101878.115438328;97294.0985970371;99426.7491717908;108369.897574797;113632.421415042;108905.456991969;103301.557738186;108074.737315269;94632.5336452661;106770.493077629;93593.5979036745;102652.993137868;100843.643908552;114535.801136701;98018.6413628181;113988.577181227;113910.235400523;111431.140129899;117327.226685045;112663.244808076;109846.892820797;108094.134197031;100727.977958732;94442.5155723287;97020.6110304849;105025.199471498;97920.8292540712;101669.687999005;98062.8895184217;114300.157684848;114917.496817207;102694.812606789;96432.2992982115;104259.877131150;116657.869381524;106079.588918036;96831.4232197582;104989.553508616;116715.788289832;107129.763787386;114830.790874962;100039.069628402;95115.5555539474;108729.511102645;101641.481774795;99188.5967966235;103345.399743162;110109.605841538;94602.0819851606;106604.529449059;94315.3930694864;94538.8293616139;106258.392011372;111196.956761169;105637.158148713;111977.474026390;117032.515564339;117352.573065162;108960.516328444;117034.238276124;105757.249899710;107453.430660344;100941.209437493;114617.270293524;106236.054794931;103398.665291700;110071.516527453;94799.3871858206;106062.902130400;114042.300898404;115036.324570889;113400.803833948;112596.248318009;98799.8989754925;114497.120865109;114903.806066163;98727.1018851024;110344.167771223;116516.617525160;102846.971003896;94633.1136984695;105170.300386134;111180.194710810;116920.975441672;98977.8443793811;99589.6825195910;100231.441139366;98030.3134774746;103526.920944477;95873.7360283797;97077.2517111261;115627.502691705;102214.031226361;115589.310331126;101792.565879883;114027.019884927;116674.546831635;94574.8058906920;111672.776923054;118309.099145869;101770.971594284;103996.331878654;116263.021114376;105052.950087177;94610.8079580719;100470.115010192;105187.559533415;103129.559176466;101232.349501030;107570.899950376;95425.0445668780;102169.139339503;118490.926962877;102375.476932500;105553.103036457;106794.018655742;115206.821471845;106305.844012933;117308.004575620;117263.554039332;111149.704163757;98468.6200687864;93763.1715079025;116647.968257963;105988.588249912;99393.5311940245;99123.9252645907;112914.630676841;104038.546103433;112893.858315138;99753.4528913696;113570.594117025;105203.529861899;96202.6089362085;114912.131690812;107519.719638690;115674.856562112;97551.5983256016;116575.157938956;110263.946724824;95915.9997299944;97655.1427275612;104490.508282319;107083.887639609;113778.083719533;99930.5117561593;106578.683980927;99228.1196220325;114380.577713218;115185.652143487;107964.588526813;117685.180768996;103481.042330802;115611.886535778;94394.5707696352;101115.054951942;102691.462039531;95996.1197421603;97069.3903488291;97003.6044798936;116735.051370269;112540.671809442;114523.160944058;111213.773941890;111462.762324588;117412.463282322;109571.323123247;97882.2831476143;114998.418557108;110806.238920669;100660.695522357;111466.665777797;113652.184347868;99956.1218229829;99182.5104322013;100107.863183600;111371.288072816;114684.479339051;96563.2012029853;111228.592091398;97385.4273609922;111308.533365741;94430.5849312990;116100.280766069;99449.5949523397;107234.065423293;113618.837888037;116193.920169252;115409.075881409;108533.169322233;101373.253609499;94659.9473187671;103802.727532081;96628.7971525834;98045.0872992714;114150.796245766;93556.9744738459;94706.4935004808;112875.821753740;101062.381083070;109105.151768839;96493.1993114921;115353.412271686;116157.105151317;101114.838902120;103990.193268648;110170.588088571;96608.5844759095;118181.245931293;101027.837319880;107121.165531952;93803.8048940435;114755.576873098;103261.324780323;106593.706552799;96444.2828688167;114209.090525708;115262.815773059;114578.431464820;109027.556513545;101474.953373746;118626.503829251;108055.277884203;111064.433065461;118355.239414557;107564.548471805;103809.367457370;93809.6695000434;118250.725762821;107900.781990575;101385.709388425;111983.713607778;98384.2286766670;100762.396693613;101681.147017883;110789.702312213;112740.289033680;109450.762528717;95980.6100255005;110295.497995439;102024.035922935;113469.342728355;103070.195781101;100374.175933913;115499.997169758;118336.049721651;117763.916224103;111632.006266618;107674.583878009;107048.941713330;106652.860758953;103569.618580482;97489.6579698768;115119.886090745;93497.7933705304;107816.403645826;113642.800452320;94475.7084547681;102891.543677806;110147.718514295;103298.922236635;108013.429941192;100986.661155451;112010.730604640;116787.291077674;118107.481843656;94120.9748859526;116458.516329386;103559.775547453;109666.017928960;114075.959414430;106619.563132375;93732.7878860871;118639.188224459;113704.110419705;111320.875201966;109764.309619697;106777.392547937;102443.621524023;111463.287429895;117449.633576813;113178.108609217;115403.853171987;118589.737105455;116274.480735305;106984.413422585;117024.905476891;115899.584657414;107903.508458277;106980.447487706;106754.405307069;111286.218256425;93635.9276273115;93792.8921181224;112149.086667835;103935.392193053;109626.927450715;103729.272057956;118597.553694794;104123.904415440;95925.5516762633;107286.348652795;102349.177042387;100869.187407350;112482.597982129;102351.574600722;95968.6718511296;101704.781618719;113092.562290742;95942.2065035868;101711.303506764;112931.271337435;101210.701282879;98257.9703085007;116790.659590909;107796.424928220;98679.8851345525;98528.3779230607;101434.463224665;115752.389184023;111604.246732580;106716.206864225;95062.1964989958;94848.7061858103;104535.340423155;107380.405051910;94245.2913313304;110428.559012797;112079.742355396;117190.178669849;109534.677725804;103950.362598740;99827.2400523517;105866.905080123;115965.931165836;109830.249433130;117651.259873268;110484.768024068;113357.443386476;103680.093881562;102297.562117440;101094.808423512;114018.392869870;106610.914545257;98537.1746460918;103564.536433738;99473.2784111574;103500.299172444;111565.458952362;103955.034391353;109005.914703937;98521.0870750282;94513.9573831378;107492.698091639;94850.0997020573;104322.144538135;104148.418221526;106548.752525599;95475.6354543499;114335.975428996;100353.753783684;105897.839844610;96030.2800252307;102929.006916581;99225.6715927105;105684.850462180;105672.064342412;105358.966007156;117488.417881787;112995.360022690;97319.4101673391;106970.484829828;111684.124878312;95626.7764787687;96507.6419168838;107042.960577280;111228.879764640;102736.657389369;95906.3202199210;109406.881228127;106340.740552965;98022.7801369567;112809.783988560;101545.615004038;95844.8892857861;116183.398695304;111231.519288228;102527.301650829;105302.912686441;98407.8957800120;115344.663743288;116132.994558726;117854.100581612;113352.797332813;113626.989108885;93504.5040113420;106454.335229124;99557.8444445860;93518.5233502158;103161.170659061;95556.1802122813;106327.768092597;106748.102844497;115983.256141128;104355.011115102;107221.848957125;108324.712507721;116897.633431861;97092.1751790688;94044.5701880343;97628.9591058063;116322.665121943;118281.266428273;99760.8677278746;117562.431579759;111558.143655036;116947.526931973;99490.9467908194;109482.947523763;108912.553712818;108236.532733316;115757.402794031;108588.873046144;107120.279939443;115350.732809060;104275.207359107;94031.5117496275;104065.510785306;107536.554856622;111726.515047441;109774.402218533;100725.101744181;100021.570385864;110099.920722916;93573.9261898603;97085.6228578484;111862.851204990;108398.029932116;99344.2090788475;104328.178732435;104631.173183978;112852.861183774;118301.244703650;111638.687253952;114641.582620654;96496.5523354802;98303.9420308440;112158.800871717;103611.041630395;104132.087687069;105772.662451197;115050.015539018;111265.075939275;94722.1878874448;105393.809162784;114709.767252859;117322.251942150;115864.232323466;117247.363086565;97611.1715573736;98310.8725137853;104377.651777485;103732.571272123;101024.420597372;95854.9897834214;99331.6719353660;111832.130256739;111675.914897027;96200.6526751200;103626.343591411;118003.741073111;116023.770890300;118563.479834624;103503.112779671;96208.6146460077;];
RR=1000;
qr=zeros(M2,1);

beta = @(k) heaviside(k);

TP=0;
FP=0;
tdelay=inf*ones(RR,1);
k0est=zeros(RR,1);
ek0=zeros(RR,1);
ePhi=zeros(RR,1);
fhat=zeros(RR,1);
fhat1=zeros(RR,1);
fhat2=zeros(RR,1);
kd=zeros(RR,1);
totaldelay=0;
totalek0=0;
totalePhi=0;
totalePhi2=0;
tpn=0;

kplus=361*288-89440;
k=1;

rhat2=rhat(89440:122689);
qnorm=Q.fltr(89440:122689)./rhat2';

Mw=7;
Md=1;
hw=0.07;

d=zeros(1,115);

TP=0;FP=0;FN=0;
Tdelay=0;
dayafterdetection=0;

%k0(1)=inf; % REMOVE THIS

for mc1=1:RR
    detection(mc1)=0;
    b=beta((1:M2)'+(89439-k0(mc1)))';
    l0=ceil((k0(mc1)-89439)/288);
    f=b.*fbar(mc1)./rhat2';
    qr=qnorm+f;
    qrs=qr((89568:103967)-89439*ones(1,288*50)); %50 days summer time
    qrw=qr((103968:122687)-89439*ones(1,288*65)); %65 days winter time
    mats = vec2mat(qrs,288);
    matw = vec2mat(qrw,288);
    w=[mean(mats(:,(2*12):(4*12)),2);mean(matw(:,(3*12):(5*12)),2)];
    for l=(Mw+1):length(w)
        d(l)=w(l)-min(w((l-Mw):(l-1)));
        if d(l)>=hw
            if l>=l0 && dayafterdetection==Md
                detection(mc1)=1;
                TP=TP+1;
                Tdelay(TP)=l-l0;
                break
            elseif l<l0  && dayafterdetection==Md
                detection(mc1)=1;
                FP=FP+1;
                break
            end
            dayafterdetection=dayafterdetection+1;
        else
            dayafterdetection=0;
        end
    end
    if detection(mc1)==0
        FN=FN+1;
    end
    fprintf('\nTP: %d, FP: %d, FN: %d, Av. delay:%6.3f',TP,FP,FN,sum(Tdelay)/TP)
end



%% SIMULATIONS FOR ADAPTIVE LEAKAGE DETECTION

clear Ser

M2=length(89440:122689);
qr=zeros(M2,1);
er=zeros(M2,1);
qrhat=zeros(M2,1);
Ts=288*7;
b.w=2*pi/Ts; % Fundamental Frequency
sf = @(k,b,j) [1 cos((1:b.n(j)).*b.w*k) sin((1:b.n(j)).*b.w*k)]';
s=zeros(1,M2);

ks=4033;

rmsqr=0;
b.n=[100];

gamma=[0.1];
phibar=[0.5];
Threshold= 30;
RR=1000;

fbar= 2.5*rand(RR,1)+0.5;
k0 = 93475+(118656-93475)*rand(RR,1);
fbar=[2.06339017868616;0.570997854428706;1.68746828261794;1.73836148040234;1.31620500588480;1.54371389638708;0.904694141795967;0.563141401096418;2.29037618442411;1.79795573554704;1.16676044273105;1.53467455172723;0.919569522814214;1.11201960915156;2.39567965925659;2.59447191403739;1.69386589883459;1.22012357367629;2.39468694393090;2.33430849839885;0.663684151597915;2.97456348079292;0.599200254021462;2.44478115590714;2.93313164349032;1.53781908264031;1.27694211160338;2.01001242849506;0.836880059220147;0.955612291314478;1.63684043993475;1.31255155384370;1.69203709969741;0.614187770735071;0.563136915655809;0.721110572152441;2.33983224601450;2.50740890627012;0.997753419407512;2.79415529371589;2.74401476205299;1.95918451739701;2.20230081576058;2.58700542237036;2.38710010242125;1.94546025194142;1.49988949991616;0.606555503449890;0.623816370856647;1.25825829461439;2.33853911970508;1.26295120868172;1.38480048133570;1.89487263272383;0.979321188273738;1.97086328302830;0.606984925379873;2.50189398673828;1.41385338647025;1.11302112584160;1.90114076670825;2.06062019404994;1.25593982812917;1.68141939537479;1.96973432142757;2.67722562353716;0.925086641348492;1.71018127116226;1.82678270999154;2.58841716615137;2.77391112766718;0.503682192170047;1.03577437931156;1.14998756016590;2.11364556773082;2.89108248112040;2.52447036293388;2.02996640157830;1.32758275200787;1.52788112031897;1.96247107586539;1.38391925367679;1.49581207271902;0.506136854700841;2.18824137064480;2.81171197153448;2.98189433625604;1.08497671689842;2.68484422891456;2.25359239203221;0.725526909643198;0.616214351414668;2.67972120835891;2.88456415621833;2.90550878613409;0.815865140002195;2.34270124620999;2.93895091490830;1.41693943668837;1.77243695753233;1.28860817101660;0.818589816931928;2.54431049794010;2.36382853461812;1.99111277499994;1.93890670401980;1.15213710262093;0.661011896707883;1.59210239727375;1.88126668277270;2.12214689392350;1.58092889913145;1.54196464073732;0.629341379730426;0.899529405340379;2.45820919233273;0.869617779518109;2.77287645438456;1.97858571829315;2.71636045021784;0.634112050619192;1.66575217982158;0.780217237014033;2.75182002824191;2.88255263624824;2.53176139492088;1.32972150463895;1.17808197151226;0.628096152959403;2.72320530359180;2.96333137782089;1.41089992278271;2.11582691715777;0.572193466821045;1.07580695370325;2.30179074541145;2.81098663910389;1.91869527661367;2.59692477997351;2.81904957501941;1.12898739660155;0.583327241615686;2.30523381224864;0.618786273850011;1.88583557374042;0.642152331208615;2.74689099670655;1.80756004010182;2.30748935921933;0.847887276233919;1.15435116385754;1.13535115971526;2.47996000479709;2.73570370108173;1.68281705240710;1.99803002366716;1.58932836351285;1.68785394645631;0.895609999812404;1.23631699944420;1.98749477368858;2.52184852446727;2.83063481989661;1.97222935631455;2.69573828048179;1.22447611624258;1.58507439417469;1.69189343028272;1.76881640458465;1.80478284097987;2.99474600563867;2.67527653942708;0.824964535665054;1.06606539208172;1.68181093090736;0.806105193852790;1.00837205513475;1.68165771746892;2.37941586805862;2.23658791165834;0.751547651104115;1.45373489591589;1.59005791062339;1.11876261191314;2.00882282439434;2.75761245490960;1.80903999689098;2.77237621852066;2.60745637823131;1.15136298984106;2.84421118783602;1.11634085427587;1.81711095651101;0.700409264215839;1.07561925447949;1.66129102700973;2.69927685473174;2.92482290802892;1.49767755629641;2.75358837604645;0.637410928875228;1.27795493549783;2.64074500212089;2.64531328143489;1.96064992021014;1.09645216733516;1.90352549730356;2.91011622499525;1.99098970877551;2.86260245348652;1.91960000754915;0.953675012619978;2.18743172328865;1.69586414831963;0.794094118904000;2.77783925093944;2.47130162400944;1.85612992355907;2.35965035590696;2.80428728644200;2.16421050203484;1.73402196214383;0.874352766871851;1.10009471795064;2.93556058210973;2.75839500096958;2.28875928320824;0.966538799751548;1.13572331401478;1.76586952395325;2.16071913139787;2.15395973047752;2.82525244004202;2.44749487048879;1.20855293259909;0.605244355408650;2.65892091446558;2.85752279371052;0.686939453536680;1.20820216037715;0.641614013919849;1.01985073754103;1.68822149363211;1.81493903405574;1.03171959247383;0.950040788709102;2.34515921651740;1.86160120808320;0.596108008171829;0.832845852525215;0.698175102758264;2.68767312223415;2.61550380218394;1.74753348542660;2.66108642719293;1.75618870674612;1.89441221980801;1.75716083796710;2.63368796635922;1.04075114568798;1.30438506732750;2.17134259338622;1.55514785200476;1.84877544510329;2.16541965507761;1.77854469076194;2.32149516588591;2.63598676991820;2.76344148482117;0.507871572467871;1.65792518689583;1.84137515431531;1.08380615861657;1.20358709193106;0.923378398598088;0.890391234945538;1.55513568517153;1.09490147844237;2.67961944156290;1.22980417991128;0.805608764821971;2.55936982008206;0.877629286522597;1.17509089676301;1.58399403329258;2.90504066296265;2.49119605516516;2.01675925069135;1.98199222718453;2.09737452755762;2.52227851761405;2.79445262348814;2.74531415932310;0.937082707835594;0.902631550900191;0.583820968493415;1.34606465280104;2.35601613925572;0.588484122296137;1.37092077813757;2.43639260973926;1.71860919748750;0.736202645344383;0.754002467868055;2.27220348306046;0.742145149411182;2.19240862736692;0.922487671974434;2.49275555789525;1.02083451222415;2.12816699622305;1.49371510420005;1.69718840019281;1.85528134233895;2.14951477493246;0.986573738017678;1.27667035032578;1.02019045719829;0.616553810347926;2.49928972670666;2.55732795292941;2.35744409356745;1.72585567391871;1.92557159579013;1.42100733776064;2.58837016100663;2.74931772428516;2.15344725256476;2.44735953894612;0.507037899272767;2.67504902242293;0.671272907393635;1.93321724887230;1.98001313527708;2.55114754076918;2.03378607429572;1.84458067146555;1.83976516184935;2.93318640702061;0.827865772635022;1.92423924952353;1.57337634221043;0.678650942102357;1.22822466113398;2.79631358731515;0.755214285126258;2.05360780486650;1.65608146811826;2.91537361085748;2.97581298918852;2.57782540667847;1.74574947484855;2.62190043553591;2.69922942939855;1.76201750636571;1.82461383183772;0.910959525483048;2.12866844352827;1.00316908824176;2.85950040614267;2.98185016207147;2.76682022660969;1.77568020496620;1.35513253495545;2.58932156265733;0.707884515833942;0.734853501169386;2.05435461213312;0.845159565958945;2.96277683404346;0.699280008954554;1.93651267185270;2.11836812671524;1.71148505266984;2.63550602810369;1.46627549151425;0.659373572551535;0.966769700788144;1.45235026235426;2.37151965288177;1.02688124520084;1.61159450677549;0.995026931889459;1.22462012648989;2.68924555343704;1.97720641661665;1.03320232261480;1.71043047996722;2.26897074285426;1.18247521040371;2.39664650572326;1.85049903966622;0.805267705258340;0.827640303450470;1.73907620943868;0.561033461117276;1.05729758186727;1.39097633741475;0.908739829994210;2.39674991901659;2.57480808550287;0.764381967515048;1.36353064702913;0.521784576196402;2.05756462873384;1.03703767074772;0.825765530300640;2.66188754183218;0.972250010997393;0.765472851592419;1.73233777013473;2.32606661529612;2.67528265026865;1.41453624178745;1.93785986217420;1.12536710590380;2.69948767188583;0.608941431023724;1.99606968310674;1.10941358527368;2.64449905996279;2.44188907399827;1.45779491214009;1.90340179515067;0.719697559054142;1.97465844017631;1.45085753841766;0.639126922687414;1.52646330400282;1.77103636126502;0.776842385878337;0.898609522263205;2.59734602429104;2.46724505711440;1.48094404239256;2.55099905277831;2.53390007494829;2.32461448631486;1.85360541606773;0.566337464580563;1.56376549990076;2.46219668484284;1.76599362791293;2.03844236842305;1.65965081789082;2.02464724546852;2.21976356384857;1.11939187631158;1.83221818947406;1.60493033884677;2.01169230035739;2.94508932972564;1.01076159764972;2.26366791481266;1.53118611116455;2.35922324957904;2.17366489543601;0.948536053349846;1.70794909865064;2.64535835557304;1.67225565577123;1.54369529313569;2.16913962768493;2.02568290707038;2.98682707472753;1.42221139657562;2.64005752565922;2.49107823599988;0.964253552289133;1.39602530825428;0.750208945941209;2.84638277416610;0.678156083415484;1.40876120254706;2.53025139510470;0.697938172437049;1.21315816697329;2.27848908566419;2.01247347727054;2.96846104548752;2.32373437702674;2.29327738875681;2.17097870531652;1.99056441697817;1.05710776676593;0.954915288380737;0.616664759505808;2.04997036887330;1.72770160690145;2.01953614211641;2.73437620151167;2.67911092184384;2.81224404772720;1.50351757696508;0.745214992500555;2.27574462854393;2.83319304438133;0.943574530001884;1.96846734716783;2.88264728796885;2.09200810240191;2.69787307335295;0.558827014754002;0.708732392744198;2.35043633656115;2.55185396423922;1.19560141733090;0.913340328256764;0.759822398970250;2.94100234778521;0.596981035170950;2.70673718384058;2.89391627264781;1.37921702467703;1.17184915426645;2.89405788031034;2.70885229159780;1.55450160003909;2.11040977494869;0.662673726386250;1.55060549590896;1.60853692546583;0.808330097488536;1.49081226618661;1.93749672264692;1.91277671089453;1.25839146999184;1.09960238040822;1.57736547035304;1.83993048434169;1.95967707978963;2.06542300978600;2.28818247842394;1.74669018326953;1.19217712076184;1.40828208371744;1.26569314502163;1.78004558106289;0.999367048905104;0.716128566655868;2.46750916309977;1.73562532241439;1.89749350543724;1.48421932571890;2.96281053255786;2.26034942034742;1.17933170047631;0.510546657160746;2.14428421218064;1.70007860132792;2.72353894005311;0.720771075240338;2.87754991586824;0.723566927653066;1.91311660581789;1.26760361052640;0.775505866386867;0.517077091420545;0.716631657031534;2.36762603080050;0.624264233415762;0.964747075723301;1.33818178723333;0.876239474429056;0.596169065159369;1.25804249667001;0.773692025419302;2.81507414127701;2.47079272109246;0.726056788743525;2.67601410690363;1.81519036218673;1.46256659543253;1.73640921896914;1.10339131421834;1.94441032779996;2.62759967895033;0.780599189321226;2.52123824953015;2.32217528646831;0.892820377336325;2.13858323768447;0.643257601408104;1.27123709313809;1.38550798657470;0.575684888272676;1.48805414390701;0.869287377444550;0.901253204606978;2.76553580752720;2.36964893763232;1.78234504444296;2.87588756315110;2.30843203630263;0.910778104097081;0.963292108293266;1.00696980083917;0.603206335455998;2.83436400277310;0.735031600212586;2.90595976250418;0.502548104758948;2.01549799726560;2.91197492766057;2.22400335602465;2.85147068595962;1.74200696940197;2.00933300647223;2.37653402920967;1.72530300682838;0.572935208502133;0.662927637424827;2.72024487769030;1.39954334160207;1.42988086046915;0.811930162018568;2.39562681888843;0.901988709408778;1.36463723753026;1.14346579684248;1.70455216572305;2.10921824012356;1.82012896965121;2.82816840410808;1.16065401136030;2.03377023122072;2.31512978331536;1.01846478493453;1.49332942960639;2.55728313168530;2.02978800846162;1.76220248795482;1.85916479053270;1.73053893025225;2.60106072854653;1.56906889772669;1.97828921600261;2.86484560134939;1.30619953011933;0.814392497939802;2.03372161456478;2.08516848708723;1.47858651524972;0.964247712791019;0.939324102851505;2.53278832572580;2.44408581580491;2.01534301470192;1.27471571677852;2.03733169646497;1.62972044915420;2.00955543526640;2.08046653807670;2.37120247704874;0.612096266177021;1.63377197611578;2.89661932313160;1.51080318977715;1.72164057378333;1.54655336325757;1.60122820730727;2.81196925815816;1.26938276864782;1.89439809477194;0.695490361618343;2.87508948342814;0.805148276842969;1.44085448395881;2.80241495055999;2.84714038922842;2.28303079687416;1.71706931724626;1.38732039659497;2.80906701642282;1.99098810738784;1.22049172463023;1.98761040045970;1.90226677765333;1.75065494864478;1.65395327767305;1.78240321251429;1.67402822263532;1.90788461953440;2.15463865233018;1.65804482534041;1.42867182761765;0.924346668047280;2.80390900787030;0.996128166172341;1.18729560786298;1.09845783929938;2.46192250217393;1.90703028124899;2.88544646627170;1.42908595000966;0.636247875750461;2.06345048118317;1.66405263648297;2.36440239318217;2.75301488427693;2.59950484858495;1.33081600376166;1.24519190730922;1.06680469024426;0.544905643282943;2.74269666096559;2.31936423794591;1.19263209457454;2.22347598528464;0.759173531522454;2.87194860583091;1.23615560775614;1.25346275931427;1.75425982132989;2.66753110614011;2.94241042314495;1.04400069965277;2.99169875666319;2.19163216126867;1.21985813070326;2.81741173616630;0.575700339513141;0.734362405469246;0.912686685603088;1.80992080456695;1.89286818994345;2.97876716384852;1.47308534388624;1.30991977091696;0.883779187888653;0.886932331108925;1.39521752160696;2.27798512290060;1.06020587719352;0.842955561731733;2.36551037648004;2.81391103803990;2.98743694291717;1.93513930916613;2.10259333298721;1.89601753339455;2.74859210558694;0.551204983247235;1.39573383727205;0.863327441181092;1.58104697659448;2.09990693543522;0.504424458592331;1.76973600345326;1.46242303335864;1.61690426857099;0.814573186777304;1.12586851125158;1.74620372707804;1.17238988601492;1.69904977793717;1.03253681947760;2.08843230466565;2.10380119619635;2.99376208347584;1.17968274601502;0.637575433736611;1.18628488104006;2.84559800643484;1.88100345302902;1.86965489730153;2.38874138643203;1.99608484437304;2.27364382353192;1.04945808387477;1.55300404069532;1.21073321551089;2.83066523703654;2.43433605587999;2.94187408533608;0.716355104439475;1.98990723671287;2.13598177274473;1.99671398936094;1.04324857666217;1.75927681863581;2.96450415655217;0.513965220439701;1.69700669509128;1.99576871517781;1.71338923905023;2.78138082519623;1.07007731172388;1.30837854498754;0.630109990503213;1.91318293814492;2.62494598398081;2.36952838145297;1.70602246848725;1.68116657984060;1.19150470970698;1.91933843470764;2.49726013158944;1.78219175238466;2.98874060998270;2.19609277860031;1.57327318375452;1.89096820453852;1.10637688896612;1.31979207554932;2.59317253690786;2.42705815353331;2.84348652456421;2.73991578573056;2.79013180700708;2.63906570481914;2.94657589992427;1.68108119132571;2.84694647964932;2.98746000954392;0.918524204341839;2.79406558279767;1.45814446517380;2.78815447836264;0.586924169301849;2.38368359341269;0.937593109563735;0.969424371082392;0.855270000704268;2.47965150616352;0.762892054163249;2.47367790107914;1.04145397382190;1.44067535332616;0.791103871777969;0.512805367899277;2.79598810175146;1.46036174069386;1.12969551703858;1.68992228809507;1.32220412162127;1.26689340956419;0.964182468204317;1.71398358024493;1.74399396407645;1.23717930020851;2.52304303587712;2.31170537907531;0.926905049457093;1.27248167844071;2.22036619031809;1.38315480413977;0.840495498886507;0.902998038208515;2.25399513673308;2.90776075084687;2.62228821467590;1.38924070390718;2.01006592725440;2.65802067718791;2.55129150532262;2.64181501659317;1.69805573964426;2.23312591257556;0.960486725913173;0.900095306502776;2.98732495959065;0.665298801063670;2.98151510265010;1.04417020745248;2.71390956283538;1.34304132626467;1.29113450290242;1.27615736126127;2.28278214617162;2.15919954907962;2.29492778361366;0.761600859724451;2.25119755206048;0.701466074456010;2.72798880781299;2.23470040436505;1.59118724833873;2.14247777366781;2.87023561677107;2.42763466145836;2.70838246453987;1.35743566504529;1.28166199529329;1.76922204553310;1.78130762569084;1.95461705847681;1.25696549785131;1.10179923890256;2.29108889543768;2.42475813905912;2.47810033496908;2.32502933508745;0.621147907014549;1.21579463951766;2.12115965587301;1.87993629588684;2.26192249496954;2.87305438449285;1.50918658771251;2.68688955896174;0.668340023086901;2.50966814390013;1.34352365185881;2.43858153941737;0.654964080394976;1.93842029951941;1.87691427765485;2.49860203147364;1.44608847013230;1.83562627726873;2.87520709488397;0.802764177669268;1.40315078797171;0.860386547279106;1.97181310738050;1.86477848644458;1.34001884744321;1.23640765823267;1.92542546537972;2.50598052733179;1.49556372665097;2.22167401772672;2.77179418931574;0.784383510306737;0.785920125460244;2.07068710640837;0.806297423240038;2.24054509963959;0.754726673600668;1.72868207946130;1.52575518291782;2.75202178677430;1.79081956366761;2.18007679274951;1.02180222752635;1.82855790444679;1.79501251449378;1.88293689909156;0.848669710438207;2.70677135875053;0.808329897482274;0.914647203125934;1.54129195573323;1.74619982046889;2.60416218763029;2.86609390145664;2.40126079925208;1.91031477993898;1.91536313851135;1.71774894117764;1.44389033749512;0.703496969776358;1.98865086499833;1.93343242880892;1.00051323835190;2.05606705353924;1.33329326974489;1.34085509876736;1.48381710719618;2.06869098255856;1.60365813828783;0.994465911705074;1.13257585772817;2.47644546642542;0.725562477116661;0.640890091084956;1.38044821826330;0.717734021881440;1.77761158316501;2.55758619252070;1.05859740285190;1.99564514331866;0.713435227036447;0.600852681308299;2.85982950720300;1.63882474320436;2.88471301271248;2.52575131191081;1.66950140102615;2.57382847973272;1.05026419062611;2.85125715099229;1.24025923965383;2.80041007331942;1.26944776242853;2.38530332190560;1.36564841470274;1.04381836750636;0.506235845466756;2.99921405686824;1.53990973476609;2.12768966826881;2.33070913169874;2.35259690112449;1.18634369084274;0.869240704043362;1.12784605572488;1.87186499775621;2.87791374289357;];
k0=[103726.591765696;95715.2339677754;100467.493230216;101919.839115834;107672.926797735;109010.561940787;115967.949911961;97836.8855201880;113697.933850795;95362.7044796634;94363.3186669653;110082.188409634;101136.924453097;109820.258032859;104587.118899747;107927.132139201;102004.646251029;100143.526789746;116003.954362502;108799.435369656;103959.586546660;117670.588663469;100729.254843137;115950.110604059;103061.563015941;116735.938691525;108235.204196918;102308.105819497;100938.076523475;102036.330307190;109463.870204248;97078.2972482126;113106.454840496;100546.546318372;100927.260139971;103421.058940941;101461.968474025;99366.6249468958;99428.3841377131;102976.095414030;95392.7431269888;113634.059398915;99208.7172222631;98328.4348429363;100023.831536828;95469.0199565494;112416.377251995;99052.0673470872;109128.831507232;95581.5124647545;113364.874097165;93948.7083797879;97071.9859510480;107588.607210064;98508.8863593318;110458.014658098;99781.8915063330;103868.780987834;108790.792802332;99257.8102696384;107084.448627364;97725.8348283562;105031.619051410;100078.814590609;100321.429908016;108610.834967920;112205.889888472;102910.611193154;116973.916460416;112403.259674460;101980.688115618;113202.992218004;98781.7153393112;113058.600198580;112510.777250713;101614.886864357;107031.923442312;105464.491485583;105759.818008192;96030.4957847805;100909.216444656;97260.2233842787;106280.056496363;108899.339130404;104375.893517644;114415.621988590;99487.7797108331;98451.8121524790;96507.2059984170;114818.696079078;95079.2166327495;115159.553397009;94917.9046864750;118216.304629710;106053.320442478;104615.458318120;104463.936098571;100818.031132957;101594.342207847;118324.338684021;118553.161141129;95237.1657010245;104049.475005386;107198.652844326;101112.347992574;100076.428507270;102329.873252053;112691.329344905;98015.1130619927;93475.2771758672;105804.675423384;100523.825051064;103944.126932636;115856.300892764;93622.0425172250;114960.649456143;102500.724965275;106723.756965422;114156.326504167;117256.664714933;97178.7391899531;117708.281258557;114236.779308664;108740.068353688;101784.453977314;112427.972714767;115192.916724471;104987.460754530;105452.632418891;94375.2248344308;115115.699600303;105221.132745077;106087.273763979;112868.447770232;115128.465062771;96078.0963839504;106843.970981054;118546.944845527;111317.565988444;111481.093540114;110592.301455840;108676.737865211;104552.503168559;97131.0107956016;102393.198171714;98793.1827628920;98668.1506057901;111056.861630037;98012.0326364352;105364.636675231;114481.594853260;115004.486341115;116346.795137767;112552.724610692;95378.6033838251;116576.447144994;111497.272155790;110503.955212756;107028.529015516;118401.239855694;96608.0416150436;115942.176476156;94106.7847717745;104587.814656791;93794.8077103705;110801.548471592;109866.372620531;107221.057554414;111130.508919334;99238.6598990463;97333.3026291675;97395.5533647228;107022.532811116;95464.1600319778;116961.235144091;97197.3282319965;105911.859302591;115322.779043747;101325.941140690;94373.0521568273;99732.2341107085;103042.398531132;116361.421157874;114961.790093963;111682.748415548;96536.7524244263;105057.965613390;103400.617404664;108654.546063401;117119.698264595;107663.485309912;108761.391961924;110627.359014794;99826.7930925680;106979.768980002;97051.6447482423;109174.122404485;106886.638746347;95189.2009845130;94199.6144580246;98256.6485147827;98764.4868913894;104411.066128024;106180.199937504;93931.1336192726;110941.404888863;97115.8729090294;118325.733980971;117625.456803263;103891.956707072;99716.9661122629;105572.345788811;117171.446247979;98281.7735795070;95118.2965363523;98587.4236659999;100047.422793229;94504.4807921543;116521.604092619;102168.039070185;109326.336577201;117727.730676922;93856.6514610633;103880.681373588;115890.419734026;115492.415696595;113882.697655140;105103.082384089;99364.9613287888;109804.006436624;98164.9383156739;98845.0225761048;96938.5912769883;118579.905697816;114047.763127403;109973.489211568;108314.473771486;108410.494470068;104327.511920314;106760.356432307;101784.874495219;99552.2876948209;114905.241263883;116491.485353474;103012.729505981;103082.472077782;106683.613725544;98951.7857597960;117643.057348795;98218.3683392946;108691.327442717;115709.308344162;103997.755178853;101716.659049480;100612.062982263;102708.793133667;113153.763507334;100982.291866289;116446.473079119;99899.4451744446;107966.426321436;95708.5168393278;106501.937186872;117630.316195314;98435.1628602604;115023.666705872;107548.347729415;105301.730249503;106103.532051396;114921.446732196;95935.3150541470;112083.676475687;97726.7774104294;97947.0196764182;101792.298028963;98876.6592860105;93899.8477512207;110318.926733217;105841.688788028;103957.977830105;102476.017925434;106223.582256751;95859.9202149134;107524.979335398;108099.147511879;106400.442379309;104114.957616088;105168.186393703;97632.2279418686;105428.504530365;103529.840689963;118654.601816865;98923.5581487720;101632.364453750;100566.647992519;100221.398093316;110273.247135110;99974.9245691018;108547.748053736;111039.830853984;104309.138580136;94310.3373739947;106432.152178040;98347.6431918508;109266.304434975;101283.575708029;99221.6192767780;95707.2970983694;95153.6253806481;100334.356282789;109200.790830356;100212.241821106;115198.827096381;116198.138542893;105331.946340996;108521.100052756;109565.879640300;99768.9733788286;105954.260884431;109855.409624408;93684.2842253128;106686.407770871;113789.136616253;100935.920939919;95548.1058550833;111071.357017665;112732.689966729;95148.2978907885;117547.970224833;108927.286849143;105574.157276254;94164.6137726116;112703.451893695;116907.562309203;97512.8948574331;117001.141192130;100654.487828087;99810.5205262284;99712.1432471814;98153.4479771646;114091.368586095;106888.569206693;110311.773953525;97141.6772519247;114823.451370899;104057.398068740;94619.6022741311;94465.8057183834;116280.663017542;97739.1050077112;115033.542290478;99133.4203304509;106124.779508720;113673.660543763;115904.527904256;111890.159437060;116414.423016924;99175.4547646120;103502.653901750;97018.7624041733;105225.203067390;103294.743562722;113122.584301769;95933.9878907148;98571.1924777983;113823.446254530;93536.8435979391;116089.001393149;107825.062309589;97230.4422194288;111779.031396134;111561.400866146;95223.7399234723;106789.637944174;98179.4294680324;98487.8634648101;110931.414742793;101434.957252337;115246.532412474;107925.964307169;98484.4001836406;109624.549346896;103532.241383401;93850.8963761259;102422.575328331;102939.736127137;111790.332950507;94553.6353434223;116510.729603996;116871.722397922;107482.992205944;104249.378657863;116567.700570204;118192.758477742;96251.9687286567;111159.081500952;97483.0796032561;97538.7388346809;109541.971426394;99005.4883655930;106937.234213136;102292.765252417;106201.198530227;105720.159884525;117022.792970340;95246.5447485851;115661.808201171;107449.236949678;97907.2169116301;115297.964008406;110618.128616482;113748.082406931;112958.658166947;104255.769051823;94602.4924196656;109382.011433491;95133.7511929937;107961.882630960;97561.3704776422;111449.129532720;102941.129115610;98932.7852966056;117171.181972070;95695.5158313009;96221.8614340777;115494.638698623;112622.978694624;95851.0400783955;108543.420734380;111301.289706599;105549.664491666;116293.764956630;95779.1295633323;101022.732584361;108533.243926178;117867.147633197;112488.697984220;110990.087838416;99504.4810356671;104226.785581947;108206.705691538;104792.056578573;102258.878711411;114532.761359065;114497.044080682;116842.685654216;106010.905258920;111095.910157393;99391.9257549181;94630.6564610137;99532.5848279702;103404.462757458;100352.188543533;96399.9844605054;105721.161401546;113725.293435330;117857.867825012;103389.231494823;96777.1408364212;112897.466179712;96489.9012936054;109153.719869140;108617.510235017;99342.0067804088;101392.669996740;116335.308389547;106745.369665811;113816.022014997;108168.719424393;102021.514377748;94869.1399838602;97004.9726595809;111651.328039569;112445.370858744;110252.600753728;108104.567200985;112120.474627827;112463.103965155;100213.274938292;116634.487861068;113263.065014569;117488.563328487;113925.527386234;106340.479504010;111626.355584313;112465.794265979;109448.861770010;97691.3633091079;100654.166564554;103389.364068835;112057.118575276;108086.827350133;94498.4910149398;94574.0428373555;96475.2113292983;115660.088908481;99140.8722597552;115938.270759013;113220.541121245;112008.063043044;95464.5414663018;103907.076610164;113337.549765316;106967.928474618;116109.663667736;93760.8802528732;103194.239319306;96352.9539133621;111751.279780778;115491.623012662;117735.626940207;100977.803603242;93963.9526679041;93988.1834572917;96536.4765584063;99395.3762736166;94587.2941686420;117482.272859644;111905.981257294;105059.066531117;107187.888314800;111661.283929097;94193.9704212305;93818.9949607200;112153.914716226;101878.115438328;97294.0985970371;99426.7491717908;108369.897574797;113632.421415042;108905.456991969;103301.557738186;108074.737315269;94632.5336452661;106770.493077629;93593.5979036745;102652.993137868;100843.643908552;114535.801136701;98018.6413628181;113988.577181227;113910.235400523;111431.140129899;117327.226685045;112663.244808076;109846.892820797;108094.134197031;100727.977958732;94442.5155723287;97020.6110304849;105025.199471498;97920.8292540712;101669.687999005;98062.8895184217;114300.157684848;114917.496817207;102694.812606789;96432.2992982115;104259.877131150;116657.869381524;106079.588918036;96831.4232197582;104989.553508616;116715.788289832;107129.763787386;114830.790874962;100039.069628402;95115.5555539474;108729.511102645;101641.481774795;99188.5967966235;103345.399743162;110109.605841538;94602.0819851606;106604.529449059;94315.3930694864;94538.8293616139;106258.392011372;111196.956761169;105637.158148713;111977.474026390;117032.515564339;117352.573065162;108960.516328444;117034.238276124;105757.249899710;107453.430660344;100941.209437493;114617.270293524;106236.054794931;103398.665291700;110071.516527453;94799.3871858206;106062.902130400;114042.300898404;115036.324570889;113400.803833948;112596.248318009;98799.8989754925;114497.120865109;114903.806066163;98727.1018851024;110344.167771223;116516.617525160;102846.971003896;94633.1136984695;105170.300386134;111180.194710810;116920.975441672;98977.8443793811;99589.6825195910;100231.441139366;98030.3134774746;103526.920944477;95873.7360283797;97077.2517111261;115627.502691705;102214.031226361;115589.310331126;101792.565879883;114027.019884927;116674.546831635;94574.8058906920;111672.776923054;118309.099145869;101770.971594284;103996.331878654;116263.021114376;105052.950087177;94610.8079580719;100470.115010192;105187.559533415;103129.559176466;101232.349501030;107570.899950376;95425.0445668780;102169.139339503;118490.926962877;102375.476932500;105553.103036457;106794.018655742;115206.821471845;106305.844012933;117308.004575620;117263.554039332;111149.704163757;98468.6200687864;93763.1715079025;116647.968257963;105988.588249912;99393.5311940245;99123.9252645907;112914.630676841;104038.546103433;112893.858315138;99753.4528913696;113570.594117025;105203.529861899;96202.6089362085;114912.131690812;107519.719638690;115674.856562112;97551.5983256016;116575.157938956;110263.946724824;95915.9997299944;97655.1427275612;104490.508282319;107083.887639609;113778.083719533;99930.5117561593;106578.683980927;99228.1196220325;114380.577713218;115185.652143487;107964.588526813;117685.180768996;103481.042330802;115611.886535778;94394.5707696352;101115.054951942;102691.462039531;95996.1197421603;97069.3903488291;97003.6044798936;116735.051370269;112540.671809442;114523.160944058;111213.773941890;111462.762324588;117412.463282322;109571.323123247;97882.2831476143;114998.418557108;110806.238920669;100660.695522357;111466.665777797;113652.184347868;99956.1218229829;99182.5104322013;100107.863183600;111371.288072816;114684.479339051;96563.2012029853;111228.592091398;97385.4273609922;111308.533365741;94430.5849312990;116100.280766069;99449.5949523397;107234.065423293;113618.837888037;116193.920169252;115409.075881409;108533.169322233;101373.253609499;94659.9473187671;103802.727532081;96628.7971525834;98045.0872992714;114150.796245766;93556.9744738459;94706.4935004808;112875.821753740;101062.381083070;109105.151768839;96493.1993114921;115353.412271686;116157.105151317;101114.838902120;103990.193268648;110170.588088571;96608.5844759095;118181.245931293;101027.837319880;107121.165531952;93803.8048940435;114755.576873098;103261.324780323;106593.706552799;96444.2828688167;114209.090525708;115262.815773059;114578.431464820;109027.556513545;101474.953373746;118626.503829251;108055.277884203;111064.433065461;118355.239414557;107564.548471805;103809.367457370;93809.6695000434;118250.725762821;107900.781990575;101385.709388425;111983.713607778;98384.2286766670;100762.396693613;101681.147017883;110789.702312213;112740.289033680;109450.762528717;95980.6100255005;110295.497995439;102024.035922935;113469.342728355;103070.195781101;100374.175933913;115499.997169758;118336.049721651;117763.916224103;111632.006266618;107674.583878009;107048.941713330;106652.860758953;103569.618580482;97489.6579698768;115119.886090745;93497.7933705304;107816.403645826;113642.800452320;94475.7084547681;102891.543677806;110147.718514295;103298.922236635;108013.429941192;100986.661155451;112010.730604640;116787.291077674;118107.481843656;94120.9748859526;116458.516329386;103559.775547453;109666.017928960;114075.959414430;106619.563132375;93732.7878860871;118639.188224459;113704.110419705;111320.875201966;109764.309619697;106777.392547937;102443.621524023;111463.287429895;117449.633576813;113178.108609217;115403.853171987;118589.737105455;116274.480735305;106984.413422585;117024.905476891;115899.584657414;107903.508458277;106980.447487706;106754.405307069;111286.218256425;93635.9276273115;93792.8921181224;112149.086667835;103935.392193053;109626.927450715;103729.272057956;118597.553694794;104123.904415440;95925.5516762633;107286.348652795;102349.177042387;100869.187407350;112482.597982129;102351.574600722;95968.6718511296;101704.781618719;113092.562290742;95942.2065035868;101711.303506764;112931.271337435;101210.701282879;98257.9703085007;116790.659590909;107796.424928220;98679.8851345525;98528.3779230607;101434.463224665;115752.389184023;111604.246732580;106716.206864225;95062.1964989958;94848.7061858103;104535.340423155;107380.405051910;94245.2913313304;110428.559012797;112079.742355396;117190.178669849;109534.677725804;103950.362598740;99827.2400523517;105866.905080123;115965.931165836;109830.249433130;117651.259873268;110484.768024068;113357.443386476;103680.093881562;102297.562117440;101094.808423512;114018.392869870;106610.914545257;98537.1746460918;103564.536433738;99473.2784111574;103500.299172444;111565.458952362;103955.034391353;109005.914703937;98521.0870750282;94513.9573831378;107492.698091639;94850.0997020573;104322.144538135;104148.418221526;106548.752525599;95475.6354543499;114335.975428996;100353.753783684;105897.839844610;96030.2800252307;102929.006916581;99225.6715927105;105684.850462180;105672.064342412;105358.966007156;117488.417881787;112995.360022690;97319.4101673391;106970.484829828;111684.124878312;95626.7764787687;96507.6419168838;107042.960577280;111228.879764640;102736.657389369;95906.3202199210;109406.881228127;106340.740552965;98022.7801369567;112809.783988560;101545.615004038;95844.8892857861;116183.398695304;111231.519288228;102527.301650829;105302.912686441;98407.8957800120;115344.663743288;116132.994558726;117854.100581612;113352.797332813;113626.989108885;93504.5040113420;106454.335229124;99557.8444445860;93518.5233502158;103161.170659061;95556.1802122813;106327.768092597;106748.102844497;115983.256141128;104355.011115102;107221.848957125;108324.712507721;116897.633431861;97092.1751790688;94044.5701880343;97628.9591058063;116322.665121943;118281.266428273;99760.8677278746;117562.431579759;111558.143655036;116947.526931973;99490.9467908194;109482.947523763;108912.553712818;108236.532733316;115757.402794031;108588.873046144;107120.279939443;115350.732809060;104275.207359107;94031.5117496275;104065.510785306;107536.554856622;111726.515047441;109774.402218533;100725.101744181;100021.570385864;110099.920722916;93573.9261898603;97085.6228578484;111862.851204990;108398.029932116;99344.2090788475;104328.178732435;104631.173183978;112852.861183774;118301.244703650;111638.687253952;114641.582620654;96496.5523354802;98303.9420308440;112158.800871717;103611.041630395;104132.087687069;105772.662451197;115050.015539018;111265.075939275;94722.1878874448;105393.809162784;114709.767252859;117322.251942150;115864.232323466;117247.363086565;97611.1715573736;98310.8725137853;104377.651777485;103732.571272123;101024.420597372;95854.9897834214;99331.6719353660;111832.130256739;111675.914897027;96200.6526751200;103626.343591411;118003.741073111;116023.770890300;118563.479834624;103503.112779671;96208.6146460077;];

Ser=zeros(M2,length(phibar)*length(gamma)*RR)';


jj=1;
beta = @(k) heaviside(k);

TP=0;
FP=0;

tdelay=inf*ones(RR,1);
k0est=zeros(RR,1);
ek0=zeros(RR,1);
ePhi=zeros(RR,1);
fhat=zeros(RR,1);
fhat1=zeros(RR,1);
fhat2=zeros(RR,1);
kd=zeros(RR,1);
totaldelay=0;
totalek0=0;
totalePhi=0;
totalePhi2=0;
tpn=0;

for mc1=1:RR
    %mc1
    FAULT=0;
    fhat2tmp=0;
    tpn=0;
    for i1=1:length(phibar)
        %i1
        for j=1:length(b.n)
                theta=zeros(2*b.n(j)+1,M2);
                for i=1:length(gamma)
                    GAMMA=gamma(i)*ones(2*b.n(j)+1,1); 
                    for k=1:M2
                        qr(k)=(Q.fltr(89439+k)+beta(89439+k-k0(mc1))*fbar(mc1))/rhat(89439+k);
                        if k>143*288 && k<=299*288,  dst=12; else dst=0; end  
                        if k<ks-1
                        elseif k==ks-1
                            Tr=288*7;
                            wr=2*pi/Tr;
                            A=[ones(k,1) cos((1:b.n(j))'*wr*(1:k))' sin((1:b.n(j))'*wr*(1:k))'];
                            theta(:,k+1)=A\qr(1:k);
                        elseif k>=(ks) 
                            z2=sf(k+dst,b,j);
                            s(k)=theta(:,k)'*z2;
                            qrhat(k)=s(k);
                            er(k)=qr(k)-qrhat(k);
                            if k>(98138-89439) && k<(98159-89439)
                                remove=0;
                            else
                                remove=1;
                            end
                            
                            if Ser(jj, k)>Threshold && ((89439+k)>=k0(mc1)) &&  FAULT==0
                                FAULT=1;
                                TP=TP+1;
                                kd(mc1)=k;
                                tdelay(mc1)=(89439+kd(mc1)-k0(mc1))/288;
                                totaldelay=totaldelay+tdelay(mc1);
                                k0est(mc1)=int32(max(find(Ser(jj,1:kd(mc1))<=0))+1);
                                fhat(mc1)=(theta(1,k0est(mc1):kd(mc1))-1)*rhat(k0est(mc1):kd(mc1))/length(k0est(mc1):kd(mc1));
                                ePhi(mc1)=abs(fbar(mc1)-fhat(mc1));
                                totalePhi=totalePhi+ePhi(mc1);
                                if mc1==7
                                    XXXX=1;
                                end
                            elseif Ser(jj, k)>Threshold && (89439+k)<k0(mc1) &&  FAULT==0
                                FP=FP+1;
                                break;
                            end
                            
                            if FAULT==1 && Ser(jj, k)>Threshold && (k<=(kd(mc1)+288*7))
                                 fhat2tmp=fhat2tmp+(theta(1,k)-1)*rhat(k); 
                                 tpn=tpn+1;
                            elseif FAULT==1 && (k>(kd(mc1)+288*7))
                                break;
                            end
                            theta(:,k+1)=theta(:,k)+ GAMMA.*z2/(0.01+z2'*z2)*er(k)*remove;
                            Ser(jj, k+1)=max([0, Ser(jj,k)+theta(1,k) - 1 - phibar(i1)/rhat(k)]);
                        end    
                    end
                    if FAULT==1
                         fhat2(mc1)= fhat2tmp/tpn;
                         totalePhi2=totalePhi2+abs(fbar(mc1)-fhat2(mc1));
                         break;
                    end
                    jj=jj+1;
                end
        end
    end
    fprintf('%d, TP:%d, FP:%d, Av.Delay:%6.3f, Fault. Err:%6.3f\n', mc1,TP,FP,totaldelay/TP, totalePhi2/TP)
end

%% TO COMPUTE THE STATS FOR ALGORITHM SENSITIVITY

M2=69601;
    qr=zeros(M2,1);
    er=zeros(M2,1);
    qrhat=zeros(M2,1);
    Ts=288*7;
    b.w=2*pi/Ts; % Fundamental Frequency
    sf = @(k,b,j) [1 cos((1:b.n(j)).*b.w*k) sin((1:b.n(j)).*b.w*k)]';
    s=zeros(1,M2);
    ks=4033;

gamma=[0.01 0.1];
rmsqr=0;
b.n=[100];


phibar=[0.5];
Ser=zeros(M2,length(phibar)*length(gamma))';

jj=1;
for i1=1:length(phibar)
    i1
    for j=1:length(b.n)
            theta=zeros(2*b.n(j)+1,M2);
            for i=1:length(gamma)
                GAMMA=gamma(i)*ones(2*b.n(j)+1,1); 
                for k=1:69601
                    qr(k)=Q.fltr(k)/rhat(k);
                    if k>143*288 && k<=299*288,  dst=12; else dst=0; end  
                    if k<ks-1
                    elseif k==ks-1
                        Tr=288*7;
                        wr=2*pi/Tr;
                        A=[ones(k,1) cos((1:b.n(j))'*wr*(1:k))' sin((1:b.n(j))'*wr*(1:k))'];
                        theta(:,k+1)=A\qr(1:k);
                    elseif k>=ks 
                        z2=sf(k+dst,b,j);
                        s(k)=theta(:,k)'*z2;
                        qrhat(k)=s(k);
                        er(k)=qr(k)-qrhat(k);
                        theta(:,k+1)=theta(:,k)+ GAMMA.*z2/(0.01+z2'*z2)*er(k);   
                        Ser(jj, k+1)=max([0, Ser(jj,k)+theta(1,k) - 1 - phibar(i1)/rhat(k)]);
                    end    
                end
                jj=jj+1;
            end
    end
end
plot(Ser')
set(0,'DefaultAxesColorOrder',[1 0 0;0 1 0;0 0 1],...
      'DefaultAxesLineStyleOrder','-|--|:')
  
disp('end')